{"version":3,"sources":["newsfeed.js"],"names":["const","newsfeed","lsKey","feedUrl","maxItems","maxAge","dismissed","done","string","months","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","match","date","Date","setUTCDate","setUTCMonth","setUTCFullYear","setUTCHours","setUTCMinutes","setUTCSeconds","delta","fuzzy","unit","hour","minute","day","week","Math","floor","item","isRecentWeek","dateDelta","element","document","createElement","dataset","identifier","className","href","link","target","innerHTML","title","description","slice","parsedDate","toLocaleString","formatRelativeDate","parentNode","removeChild","keys","Object","length","let","i","localStorage","JSON","stringify","axios","get","responseType","then","response","data","documentElement","Element","Error","items","querySelectorAll","parse","id","column","querySelector","min","titleElement","descriptionElement","pubDateElement","linkElement","textContent","pubDate","simpleParseDate","round","notificationElement","formatNotification","dismissTrigger","addEventListener","event","preventDefault","dismissNotification","appendChild","body","catch","console","error","page","apiChecked","do","readyState","onloaded","window"],"mappings":"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","file":"newsfeed.js","sourcesContent":["/* global page, axios */\n\nconst newsfeed = {\n  lsKey: 'newsfeed',\n  feedUrl: 'https://blog.fiery.me/rss-newsfeed.xml',\n  maxItems: 3,\n  maxAge: 91 * 24 * 60 * 60, // 91 days (~3 months)\n  dismissed: {},\n  done: false\n}\n\nnewsfeed.simpleParseDate = string => {\n  // For now limited to support the following examples (used in blog.fiery.me):\n  // Mon, 27 Jul 2020 18:30:00 GMT\n  // Sat, 16 May 2020 14:55:00 GMT\n  // Probably better to use a library if it needs to support other formats.\n  const months = { Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5, Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11 }\n  const match = string.match(/[a-zA-Z]*,\\s(\\d{2})\\s([a-zA-Z]{3})\\s(\\d{4})\\s(\\d{2}):(\\d{2}):(\\d{2})\\sGMT/)\n  if (match && (typeof months[match[2]] !== 'undefined')) {\n    const date = new Date()\n    date.setUTCDate(match[1])\n    date.setUTCMonth(months[match[2]])\n    date.setUTCFullYear(match[3])\n    date.setUTCHours(match[4])\n    date.setUTCMinutes(match[5])\n    date.setUTCSeconds(match[6])\n    return date\n  }\n}\n\nnewsfeed.formatRelativeDate = delta => {\n  // https://stackoverflow.com/a/7641812\n  // CC BY-SA 3.0\n  const minute = 60\n  const hour = minute * 60\n  const day = hour * 24\n  const week = day * 7\n\n  let fuzzy\n  let unit\n  if (delta < minute) {\n    fuzzy = delta\n    unit = 'second'\n  } else if (delta < hour) {\n    fuzzy = Math.floor(delta / minute)\n    unit = 'minute'\n  } else if (delta < day) {\n    fuzzy = Math.floor(delta / hour)\n    unit = 'hour'\n  } else if (delta < week) {\n    fuzzy = Math.floor(delta / day)\n    unit = 'day'\n  } else {\n    fuzzy = Math.floor(delta / week)\n    unit = 'week'\n  }\n\n  return `${fuzzy} ${unit}${fuzzy !== 1 ? 's' : ''} ago`\n}\n\nnewsfeed.formatNotification = item => {\n  const isRecentWeek = item.dateDelta <= (7 * 24 * 60 * 60) // 7 days (1 week)\n  const element = document.createElement('a')\n  element.dataset.identifier = item.identifier\n  element.className = 'notification is-info'\n  element.href = item.link\n  element.target = '_blank'\n  element.innerHTML = `\n    <button class=\"delete\" title=\"Dismiss\"></button>\n    <div class=\"content\">\n      <div class=\"news-title\">\n        ${item.title || 'Untitled'}\n      </div>\n      <div class=\"news-excerpt\">\n        ${item.description\n          ? `${item.description.slice(-1) === '…' ? `${item.description.slice(0, -1)} […]` : item.description}`\n          : 'N/A'}\n      </div>\n      <div class=\"news-date${isRecentWeek ? ' is-recent-week' : ''}\">\n        <span title=\"${item.parsedDate.toLocaleString()}\">${newsfeed.formatRelativeDate(item.dateDelta)}</span>\n      </div>\n    <div>\n  `\n  return element\n}\n\nnewsfeed.dismissNotification = element => {\n  if (!element || !element.dataset.identifier) return\n\n  newsfeed.dismissed[element.dataset.identifier] = 1\n  element.parentNode.removeChild(element)\n\n  const keys = Object.keys(newsfeed.dismissed)\n  if (keys.length > newsfeed.maxItems) {\n    for (let i = 0; i < keys.length - newsfeed.maxItems; i++) {\n      delete newsfeed.dismissed[keys[i]]\n    }\n  }\n\n  localStorage[newsfeed.lsKey] = JSON.stringify(newsfeed.dismissed)\n}\n\nnewsfeed.do = () => {\n  return axios.get(newsfeed.feedUrl, {\n    responseType: 'document'\n  }).then(response => {\n    if (response && response.data && response.data.documentElement instanceof Element) {\n      const items = response.data.documentElement.querySelectorAll('item')\n\n      if (items.length) {\n        const dismissed = localStorage[newsfeed.lsKey]\n        if (dismissed) {\n          newsfeed.dismissed = JSON.parse(dismissed)\n        }\n\n        const element = document.createElement('section')\n        element.id = 'newsfeed'\n        element.className = 'section'\n        element.innerHTML = `\n          <div class=\"columns is-gapless\">\n            <div class=\"column is-hidden-mobile\"></div>\n            <div class=\"column is-hidden-mobile\"></div>\n            <div class=\"column has-text-right\"></div>\n          </div>\n        `\n        const column = element.querySelector('.columns > .column:last-child')\n\n        for (let i = 0; i < Math.min(newsfeed.maxItems, items.length); i++) {\n          const titleElement = items[i].querySelector('title')\n          const descriptionElement = items[i].querySelector('description')\n          const pubDateElement = items[i].querySelector('pubDate')\n          const linkElement = items[i].querySelector('link')\n\n          const title = titleElement ? titleElement.textContent : ''\n          const description = descriptionElement ? descriptionElement.textContent : ''\n          const pubDate = pubDateElement ? pubDateElement.textContent : ''\n          const link = linkElement ? linkElement.textContent : ''\n\n          const identifier = title + '|' + description + '|' + pubDate + '|' + link\n\n          if (!newsfeed.dismissed[identifier]) {\n            const parsedDate = newsfeed.simpleParseDate(pubDate)\n            const dateDelta = Math.round((+new Date() - parsedDate) / 1000)\n\n            if (typeof newsfeed.maxAge === 'number' && dateDelta <= newsfeed.maxAge) {\n              const notificationElement = newsfeed.formatNotification({\n                title, description, pubDate, link, identifier, parsedDate, dateDelta\n              })\n\n              const dismissTrigger = notificationElement.querySelector('.delete')\n              if (dismissTrigger) {\n                dismissTrigger.addEventListener('click', function () {\n                  event.preventDefault()\n                  newsfeed.dismissNotification(event.target.parentNode)\n                })\n              }\n\n              column.appendChild(notificationElement)\n            }\n          }\n        }\n\n        document.body.appendChild(element)\n      }\n    } else {\n      throw Error('response.data.documentElement is NOT an instance of Element')\n    }\n  }).catch(console.error)\n}\n\nnewsfeed.onloaded = () => {\n  // If the main script had already done its API check, yet newsfeed haven't been triggered, do it\n  // This would only happen if this newsfeed script only gets loaded after the main script's API check\n  if (typeof page !== 'undefined' && page.apiChecked && !newsfeed.done) {\n    newsfeed.do()\n  }\n}\n\nif (document.readyState === 'interactive' || document.readyState === 'complete') {\n  newsfeed.onloaded()\n} else {\n  window.addEventListener('DOMContentLoaded', () => newsfeed.onloaded())\n}\n"]}